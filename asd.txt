import os, streamlit as st
import joblib
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns 

# Definisi Ulang Fungsi
def log_transform(X):
    return np.log1p(X)

# Muat model
try:
    model = joblib.load('random_forest_model.pkl')
    st.success("Model berhasil dimuat!")
except FileNotFoundError:
    st.error("File model 'random_forest_model.pkl' tidak ditemukan. Pastikan sudah disimpan dari training.")
    st.stop()
except Exception as e:
    st.error(f"Error saat memuat model: {str(e)}")
    st.stop()

st.title("Prediksi Kelangsungan Hidup Pasien Gagal Jantung")
st.write("Masukkan data pasien untuk memprediksi risiko kematian (DEATH_EVENT).")

# --- DATA DICTIONARY SECTION (Tampil Langsung dan Menggunakan st.table) ---
st.markdown("---") 
st.subheader("Data Dictionary & Rentang Normal")

# Data Dictionary
data = {
    'Variabel': ['age', 'anaemia', 'creatinine_phosphokinase', 'diabetes', 'ejection_fraction', 'high_blood_pressure', 'platelets', 'serum_creatinine', 'serum_sodium', 'sex', 'smoking', 'time', 'DEATH_EVENT'],
    'Tipe Data': ['float64', 'int64', 'int64', 'int64', 'int64', 'int64', 'float64', 'float64', 'int64', 'int64', 'int64', 'int64', 'int64'],
    'Deskripsi': [
        'Usia pasien dalam tahun',
        'Anemia (0=Tidak, 1=Ya)',
        'Level enzim CPK dalam darah (mcg/L)',
        'Diabetes (0=Tidak, 1=Ya)',
        'Persentase darah yang dipompa keluar dari jantung setiap kontraksi (%)',
        'Tekanan darah tinggi (0=Tidak, 1=Ya)',
        'Jumlah trombosit dalam darah (kiloplatelets/mL)',
        'Level kreatinin dalam serum darah (mg/dL)',
        'Level natrium dalam serum darah (mEq/L)',
        'Jenis kelamin (1=Pria, 0=Wanita)',
        'Merokok (0=Tidak, 1=Ya)',
        'Lama waktu observasi atau tindak lanjut (hari)',
        'Status kematian pasien (Target: 0=Bertahan, 1=Meninggal)'
    ],
    'Rentang Normal/Keterangan': [
        'N/A',
        'N/A',
        '< 200 mcg/L',
        'N/A',
        '50%-70%',
        'N/A',
        '150.000 - 450.000',
        '0.6 - 1.3 mg/dL',
        '135 - 145 mEq/L',
        'N/A',
        'N/A',
        'Tidak digunakan untuk prediksi input',
        'Target prediksi'
    ]
}
df_dict = pd.DataFrame(data)
st.table(df_dict) # Menggunakan st.table

st.markdown("---") 
# ----------------------------------------


# Form input fitur dengan Peningkatan UX
with st.form(key='input_form'):
    # Input field menggunakan help text yang merujuk Data Dictionary
    age = st.number_input("Usia (age)", min_value=0.0, max_value=120.0, value=50.0, help="Umur pasien.")
    
    # UX: Menggunakan label deskriptif untuk fitur biner
    anaemia_label = st.selectbox("Anemia", ['Tidak', 'Ya'], index=0)
    
    # UX: Menambahkan Satuan dan Normal Range
    creatinine_phosphokinase = st.number_input("Creatinine Phosphokinase (CPK) (mcg/L)", min_value=0, value=582, help="Level enzim CPK dalam darah. Normalnya < 200 mcg/L.")
    
    diabetes_label = st.selectbox("Diabetes", ['Tidak', 'Ya'], index=0)
    
    # UX: Menambahkan Satuan dan Normal Range
    ejection_fraction = st.number_input("Ejection Fraction (%)", min_value=0, max_value=100, value=40, help="Persentase darah yang dipompa keluar dari jantung. Normalnya 50%-70%.")
    
    high_blood_pressure_label = st.selectbox("Tekanan Darah Tinggi", ['Tidak', 'Ya'], index=0)
    
    # UX: Menambahkan Satuan dan Normal Range
    platelets = st.number_input("Platelets (kiloplatelets/mL)", min_value=0.0, value=265000.0, help="Jumlah trombosit dalam darah. Normalnya 150.000 - 450.000 kiloplatelets/mL.")
    
    # UX: Menambahkan Satuan dan Normal Range
    serum_creatinine = st.number_input("Serum Creatinine (mg/dL)", min_value=0.0, value=1.0, help="Level kreatinin dalam serum darah. Normalnya 0.6 - 1.3 mg/dL.")
    
    # UX: Menambahkan Satuan dan Normal Range
    serum_sodium = st.number_input("Serum Sodium (mEq/L)", min_value=0, value=135, help="Level natrium dalam serum darah. Normalnya 135 - 145 mEq/L.")
    
    # UX: Mengubah format sex agar lebih user-friendly
    sex_label = st.selectbox("Jenis Kelamin", ['Pria', 'Wanita'], index=0) 
    
    smoking_label = st.selectbox("Merokok", ['Tidak', 'Ya'], index=0)
    
    submit_button = st.form_submit_button(label='Prediksi')

# Konversi label string ke nilai numerik (0/1) untuk model
anaemia = 1 if anaemia_label == 'Ya' else 0
diabetes = 1 if diabetes_label == 'Ya' else 0
high_blood_pressure = 1 if high_blood_pressure_label == 'Ya' else 0
smoking = 1 if smoking_label == 'Ya' else 0
sex = 1 if sex_label == 'Pria' else 0 # 1=Pria, 0=Wanita

# Proses prediksi jika submit
if submit_button:
    # Buat DataFrame dari input
    input_data = {
        'age': [age],
        'anaemia': [anaemia],
        'creatinine_phosphokinase': [creatinine_phosphokinase],
        'diabetes': [diabetes],
        'ejection_fraction': [ejection_fraction],
        'high_blood_pressure': [high_blood_pressure],
        'platelets': [platelets],
        'serum_creatinine': [serum_creatinine],
        'serum_sodium': [serum_sodium],
        'sex': [sex],
        'smoking': [smoking]
    }
    input_df = pd.DataFrame(input_data)
    
    # Prediksi
    try:
        prediction = model.predict(input_df)[0]
        probability = model.predict_proba(input_df)[0][1]  # Probabilitas kelas 1 (Meninggal)
        
        # Tampilkan hasil
        st.subheader("Hasil Prediksi:")
        if prediction == 0:
            st.success(f"Prediksi: Bertahan (0)")
        else:
            st.error(f"Prediksi: Meninggal (1)")
        st.write(f"Probabilitas Kematian: {probability:.4f}")
        
        # Visualisasi Pie Chart
        st.subheader("Visualisasi Probabilitas")
        probabilities = [1 - probability, probability]
        labels = ['Bertahan', 'Meninggal']
        
        # Menggunakan Set2 palette dari Seaborn
        colors = sns.color_palette("Set2", 2)
        
        fig, ax = plt.subplots()
        ax.pie(probabilities, 
               labels=labels, 
               colors=colors, 
               autopct='%.1f%%', 
               startangle=90,
               textprops={'color': "black"})
        ax.axis('equal') 
        ax.set_title("Distribusi Probabilitas")
        st.pyplot(fig)

    except Exception as e:
        st.error(f"Error saat prediksi: {str(e)}")